'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
/* The property-seek module literally copied and pasted here for conveinence. */

var _ts = function _ts(o, txt) {
  var dtxt = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';
  return o.typescript ? txt : dtxt;
};

var _typescriptProperties = function _typescriptProperties() {
  return '\n  ids: {[key:string]: WMLElement};\n  widgets: Widget[];\n  tree: HTMLElement;\n  context: object;\n  template: ()=>HTMLElement;\n';
};

var _view = function _view() {
  return '\n\nexport interface View {\n\n render(): HTMLElement;\n findById(id:string): WMLElement;\n\n}';
};

var _widget = function _widget() {
  return '\nexport interface Widget {\n\n  rendered(): void;\n  removed(): void;\n  render(): HTMLElement;\n\n}';
};

var _element = function _element() {
  return 'export type WMLElement = HTMLElement | Node | EventTarget | Widget';
};

var preamble = exports.preamble = function preamble(o) {
  return '\n\nfunction $$boundary_to_dot(value) {\n  return value.split(\'][\').join(\'.\').split(\'[\').join(\'.\');\n}\n\nfunction $$strip_braces(value) {\n  return value.split(\'[\').join(\'.\').split(\']\').join(\'\');\n}\n\nfunction $$escape_dots(value) {\n  value = value.split(\'\\\'\');\n  return (value.length < 3) ? value.join(\'\\\'\') : value.map(function(seg) {\n    if (seg.length < 3) return seg;\n    if ((seg[0] === \'.\') || (seg[seg.length - 1] === \'.\')) return seg;\n    return seg.split(\'.\').join(\'&&\');\n  }).join(\'\');\n}\n\nfunction $$unescape_dots(value) {\n  return value.split(\'&&\').join(\'.\');\n}\n\nfunction $$partify(value) {\n  if (!value) return;\n  return $$escape_dots($$strip_braces($$boundary_to_dot(\'\' + value))).split(\'.\');\n}\n\nfunction $$property(path, o) {\n\n  var parts = $$partify(path);\n  var first;\n\n  if (typeof o !== \'object\')\n    throw new TypeError(\'get(): expects an object got \' + typeof o);\n\n  if (parts.length === 1) return o[$$unescape_dots(parts[0])];\n  if (parts.length === 0) return;\n\n  first = o[parts.shift()];\n\n  return ((typeof o === \'object\') && (o !== null)) ?\n\n    parts.reduce(function(target, prop) {\n      if (target == null) return target;\n      return target[$$unescape_dots(prop)];\n    }, first) : null;\n}\n\nfunction $$adopt(child, e) {\n\n    if (Array.isArray(child))\n      return child.forEach(innerChild => $$adopt(innerChild, e));\n\n    if (child)\n      e.appendChild(\n        (typeof child === \'object\') ?\n        child : document.createTextNode(child == null? \'\' : child));\n\n}\n\n/**\n * $$text creates a DOMTextNode\n * @param {string} value\n */\nfunction $$text(value) {\n\n  return document.createTextNode(value == null ?  \'\' : value);\n\n}\n\n/**\n * $$resolve property access expression to avoid\n * thowing errors if it does not exist.\n * @param {object} head\n * @param {string} path\n */\nfunction $$resolve(head, path) {\n\n    if((head == null) || head == \'\')\n        return \'\';\n\n  var ret = $$property(path, head);\n\n  return (ret == null) ? \'\' : ret;\n\n}\n\n/**\n * $$node is called to create a regular DOM node\n * @param {string} tag\n * @param {object} attributes\n * @param {array<string|number|Widget>} children\n * @param {View} view\n */\nfunction $$node(tag, attributes, children, view) {\n\n  var e = (tag === \'fragment\') ? document.createDocumentFragment() : document.createElement(tag);\n\n  if (typeof attributes.html === \'object\')\n    Object.keys(attributes.html).forEach(key => {\n\n      if (typeof attributes.html[key] === \'function\') {\n        e[key] = attributes.html[key];\n      } else if((attributes.html[key] != null) && (attributes.html[key] != \'\')) {\n          console.error(\'well \', key, attributes.html[key]);\n        e.setAttribute(key, attributes.html[key]);\n      }\n    });\n\n  children.forEach(c => $$adopt(c, e));\n\n  if (attributes.wml)\n    if (attributes.wml.id)\n      view.register(attributes.wml.id, e);\n\n  return e;\n\n}\n\n/**\n * Attributes provides an API for reading the\n * attributes supplied to an Element.\n * @param {object} attrs\n */\nclass Attributes {\n\n    constructor(' + _ts(o, 'public _attrs:any', '_attrs') + ') {\n\n        this._attrs = _attrs;\n\n    }\n\n    ' + _ts(o, 'has(path:string): boolean', 'has(path)') + '{\n\n      return this.read(path) != null;\n\n    }\n\n    /**\n     * read a value form the internal list.\n     * @param {string} path\n     * @param {*} defaultValue - This value is returned if the value is not set.\n     */\n    ' + _ts(o, 'read<A>(path:string, defaultValue?:A): A', 'read(path, defaultValue)') + ' {\n\n        var ret = $$property(path.split(\':\').join(\'.\'), this._attrs);\n      return (ret != null) ? ret : (defaultValue != null) ? defaultValue : \'\';\n\n    }\n\n}\n\n\n/**\n * $$widget creates a wml widget.\n * @param {function} Construtor\n * @param {object} attributes\n * @param {array<string|number|Widget>} children\n * @param {View} view\n * @return {Widget}\n */\nfunction $$widget(Constructor, attributes, children, view) {\n\n  var childs = [];\n  var w;\n\n  children.forEach(child => Array.isArray(child) ?\n    childs.push.apply(childs, child) : childs.push(child));\n\n  w = new Constructor(new Attributes(attributes), childs);\n\n  if (attributes.wml)\n    if (attributes.wml.id)\n      view.register(attributes.wml.id, w);\n\n  view.widgets.push(w);\n  return w.render();\n\n}\n\n/**\n * $$if is called to create an if conditional construct\n * @param {*} predicate\n * @param {function} positive\n * @param {function} negative\n */\nfunction $$if(predicate, positive, negative) {\n\n  return (predicate) ? positive() : negative();\n\n}\n\n/**\n * $$for is called to create a for loop construct\n * @param {Iterable} collection\n * @param {function} cb\n */\nfunction $$for(collection, cb) {\n\n  if (Array.isArray(collection)) {\n\n    return collection.map(cb);\n\n   } else if (typeof collection === \'object\') {\n\n     return Object.keys(collection).map((key, _, all) => cb(collection[key], key, all));\n\n   }\n\n    return [];\n\n}\n\n/**\n * $$switch simulates a switch statement\n * @param {string|number|boolean} value\n * @param {object} cases\n */\nfunction $$switch(value, cases) {\n\n    var result = cases[value];\n    var defaul = cases.default;\n\n    if (result) return result;\n\n    if (defaul) return defaul;\n\n}\n\n' + _ts(o, _view()) + '\n' + _ts(o, _widget()) + '\n' + _ts(o, _element());
};

var _rootElement = function _rootElement(root, o) {
  return root ? root.transpile(o) : o.typescript ? '<HTMLElement><Node>document.createDocumentFragment()' : 'document.createDocumentFragment()';
};

var view = exports.view = function view(name, tag, o) {
  return 'export class ' + name + ' ' + (o.typescript ? 'implements View' : '') + '{\n\n      ' + (o.typescript ? _typescriptProperties() : '') + '\n\n       constructor(context) {\n\n          let view = this;\n\n          this.ids = {};\n          this.widgets = [];\n\n          this.tree = null;\n          this.context = context;\n          this.template = function(){\n            return ' + _rootElement(tag, o) + '\n          }\n\n       }\n\n       static render(context) {\n\n         return (new ' + name + '(context)).render();\n\n       }\n\n       ' + (o.typescript ? 'register(id:string, w:WMLElement): ' + name : 'register(id, w)') + '{\n\n\n         if (this.ids.hasOwnProperty(id))\n           throw new Error(\'Duplicate id \\\'\' +id+\'\\\' detected!\');\n\n         this.ids[id] = w;\n         return this;\n\n       }\n\n       ' + (o.typescript ? 'findById(id:string) : WMLElement ' : 'findById(id)') + '{\n\n        return (this.ids[id]) ? this.ids[id] : null;\n\n       }\n\n       ' + (o.typescript ? 'invalidate(): void' : 'invalidate()') + ' {\n\n        var childs;\n        var parent = this.tree.parentNode;\n        var realFirstChild;\n        var realFirstChildIndex;\n\n         if (this.tree == null)\n           throw new ReferenceError(\'Cannot invalidate a view that has not been rendered!\');\n\n         if (this.tree.parentNode == null)\n           throw new ReferenceError(\'Attempt to invalidate a view that has not been inserted to DOM!\');\n\n         childs = ' + (o.typescript ? '(<Element> this.tree.parentNode)' : 'this.tree.parentNode') + '.children;\n\n         //for some reason the reference stored does not have the correct parent node.\n         //we do this to get a \'live\' version of the node.\n         for (let i = 0; i < childs.length; i++)\n           if (childs[i] === this.tree) {\n             realFirstChild = childs[i];\n             realFirstChildIndex = i;\n           }\n\n         parent.replaceChild(this.render(), realFirstChild);\n\n       }\n\n       render() {\n\n        this.ids = {};\n        this.widgets.forEach(w => w.removed());\n        this.widgets = [];\n        this.tree = this.template.call(this.context);\n        this.ids[\'root\'] = (this.ids[\'root\'])? this.ids[\'root\']:this.tree;\n        this.widgets.forEach(w => w.rendered());\n\n        return this.tree;\n\n      }\n\n     }\n\n    ';
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYXJzZXIvVGVtcGxhdGVzLmpzIl0sIm5hbWVzIjpbIl90cyIsIm8iLCJ0eHQiLCJkdHh0IiwidHlwZXNjcmlwdCIsIl90eXBlc2NyaXB0UHJvcGVydGllcyIsIl92aWV3IiwiX3dpZGdldCIsIl9lbGVtZW50IiwicHJlYW1ibGUiLCJfcm9vdEVsZW1lbnQiLCJyb290IiwidHJhbnNwaWxlIiwidmlldyIsIm5hbWUiLCJ0YWciXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7O0FBRUEsSUFBTUEsTUFBTSxTQUFOQSxHQUFNLENBQUNDLENBQUQsRUFBSUMsR0FBSjtBQUFBLE1BQVNDLElBQVQsdUVBQWdCLEVBQWhCO0FBQUEsU0FBdUJGLEVBQUVHLFVBQUYsR0FBZUYsR0FBZixHQUFxQkMsSUFBNUM7QUFBQSxDQUFaOztBQUVBLElBQU1FLHdCQUF3QixTQUF4QkEscUJBQXdCO0FBQUE7QUFBQSxDQUE5Qjs7QUFTQSxJQUFNQyxRQUFRLFNBQVJBLEtBQVE7QUFBQTtBQUFBLENBQWQ7O0FBU0EsSUFBTUMsVUFBVSxTQUFWQSxPQUFVO0FBQUE7QUFBQSxDQUFoQjs7QUFTQSxJQUFNQyxXQUFXLFNBQVhBLFFBQVc7QUFBQTtBQUFBLENBQWpCOztBQUdPLElBQU1DLDhCQUFXLFNBQVhBLFFBQVc7QUFBQSxpb0dBK0hOVCxJQUFJQyxDQUFKLEVBQU8sbUJBQVAsRUFBNkIsUUFBN0IsQ0EvSE0sNkRBcUlsQkQsSUFBSUMsQ0FBSixFQUFPLDJCQUFQLEVBQW9DLFdBQXBDLENBcklrQixpUEFnSmxCRCxJQUFJQyxDQUFKLEVBQU8sMENBQVAsRUFBbUQsMEJBQW5ELENBaEprQiwrdURBc090QkQsSUFBSUMsQ0FBSixFQUFPSyxPQUFQLENBdE9zQixVQXVPdEJOLElBQUlDLENBQUosRUFBT00sU0FBUCxDQXZPc0IsVUF3T3RCUCxJQUFJQyxDQUFKLEVBQU9PLFVBQVAsQ0F4T3NCO0FBQUEsQ0FBakI7O0FBME9QLElBQU1FLGVBQWUsU0FBZkEsWUFBZSxDQUFDQyxJQUFELEVBQU9WLENBQVA7QUFBQSxTQUNqQlUsT0FBT0EsS0FBS0MsU0FBTCxDQUFlWCxDQUFmLENBQVAsR0FBNEJBLEVBQUVHLFVBQUgsR0FDM0Isc0RBRDJCLEdBRTNCLG1DQUhpQjtBQUFBLENBQXJCOztBQUtPLElBQU1TLHNCQUFPLFNBQVBBLElBQU8sQ0FBQ0MsSUFBRCxFQUFPQyxHQUFQLEVBQVlkLENBQVo7QUFBQSwyQkFFQWEsSUFGQSxVQUVRYixFQUFFRyxVQUFGLEdBQWMsaUJBQWQsR0FBa0MsRUFGMUMscUJBSVhILEVBQUVHLFVBQUgsR0FBZ0JDLHVCQUFoQixHQUEwQyxFQUo5QixnUUFnQkNLLGFBQWFLLEdBQWIsRUFBa0JkLENBQWxCLENBaEJELDZGQXVCR2EsSUF2Qkgsb0RBMkJYYixFQUFFRyxVQUFGLEdBQWMsd0NBQXNDVSxJQUFwRCxHQUEyRCxpQkEzQmhELGlOQXNDWGIsRUFBRUcsVUFBRixHQUFjLG1DQUFkLEdBQW9ELGNBdEN6QywwRkE0Q1hILEVBQUVHLFVBQUYsR0FBYyxvQkFBZCxHQUFxQyxjQTVDMUIsZ2NBeURBSCxFQUFFRyxVQUFGLEdBQWMsa0NBQWQsR0FBbUQsc0JBekRuRDtBQUFBLENBQWIiLCJmaWxlIjoiVGVtcGxhdGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogVGhlIHByb3BlcnR5LXNlZWsgbW9kdWxlIGxpdGVyYWxseSBjb3BpZWQgYW5kIHBhc3RlZCBoZXJlIGZvciBjb252ZWluZW5jZS4gKi9cblxuY29uc3QgX3RzID0gKG8sIHR4dCwgZHR4dCA9ICcnKSA9PiBvLnR5cGVzY3JpcHQgPyB0eHQgOiBkdHh0O1xuXG5jb25zdCBfdHlwZXNjcmlwdFByb3BlcnRpZXMgPSAoKSA9PiBgXG4gIGlkczoge1trZXk6c3RyaW5nXTogV01MRWxlbWVudH07XG4gIHdpZGdldHM6IFdpZGdldFtdO1xuICB0cmVlOiBIVE1MRWxlbWVudDtcbiAgY29udGV4dDogb2JqZWN0O1xuICB0ZW1wbGF0ZTogKCk9PkhUTUxFbGVtZW50O1xuYDtcblxuXG5jb25zdCBfdmlldyA9ICgpID0+IGBcblxuZXhwb3J0IGludGVyZmFjZSBWaWV3IHtcblxuIHJlbmRlcigpOiBIVE1MRWxlbWVudDtcbiBmaW5kQnlJZChpZDpzdHJpbmcpOiBXTUxFbGVtZW50O1xuXG59YDtcblxuY29uc3QgX3dpZGdldCA9ICgpID0+IGBcbmV4cG9ydCBpbnRlcmZhY2UgV2lkZ2V0IHtcblxuICByZW5kZXJlZCgpOiB2b2lkO1xuICByZW1vdmVkKCk6IHZvaWQ7XG4gIHJlbmRlcigpOiBIVE1MRWxlbWVudDtcblxufWA7XG5cbmNvbnN0IF9lbGVtZW50ID0gKCkgPT5cbiAgICBgZXhwb3J0IHR5cGUgV01MRWxlbWVudCA9IEhUTUxFbGVtZW50IHwgTm9kZSB8IEV2ZW50VGFyZ2V0IHwgV2lkZ2V0YDtcblxuZXhwb3J0IGNvbnN0IHByZWFtYmxlID0gbyA9PiBgXG5cbmZ1bmN0aW9uICQkYm91bmRhcnlfdG9fZG90KHZhbHVlKSB7XG4gIHJldHVybiB2YWx1ZS5zcGxpdCgnXVsnKS5qb2luKCcuJykuc3BsaXQoJ1snKS5qb2luKCcuJyk7XG59XG5cbmZ1bmN0aW9uICQkc3RyaXBfYnJhY2VzKHZhbHVlKSB7XG4gIHJldHVybiB2YWx1ZS5zcGxpdCgnWycpLmpvaW4oJy4nKS5zcGxpdCgnXScpLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiAkJGVzY2FwZV9kb3RzKHZhbHVlKSB7XG4gIHZhbHVlID0gdmFsdWUuc3BsaXQoJ1xcXFwnJyk7XG4gIHJldHVybiAodmFsdWUubGVuZ3RoIDwgMykgPyB2YWx1ZS5qb2luKCdcXFxcJycpIDogdmFsdWUubWFwKGZ1bmN0aW9uKHNlZykge1xuICAgIGlmIChzZWcubGVuZ3RoIDwgMykgcmV0dXJuIHNlZztcbiAgICBpZiAoKHNlZ1swXSA9PT0gJy4nKSB8fCAoc2VnW3NlZy5sZW5ndGggLSAxXSA9PT0gJy4nKSkgcmV0dXJuIHNlZztcbiAgICByZXR1cm4gc2VnLnNwbGl0KCcuJykuam9pbignJiYnKTtcbiAgfSkuam9pbignJyk7XG59XG5cbmZ1bmN0aW9uICQkdW5lc2NhcGVfZG90cyh2YWx1ZSkge1xuICByZXR1cm4gdmFsdWUuc3BsaXQoJyYmJykuam9pbignLicpO1xufVxuXG5mdW5jdGlvbiAkJHBhcnRpZnkodmFsdWUpIHtcbiAgaWYgKCF2YWx1ZSkgcmV0dXJuO1xuICByZXR1cm4gJCRlc2NhcGVfZG90cygkJHN0cmlwX2JyYWNlcygkJGJvdW5kYXJ5X3RvX2RvdCgnJyArIHZhbHVlKSkpLnNwbGl0KCcuJyk7XG59XG5cbmZ1bmN0aW9uICQkcHJvcGVydHkocGF0aCwgbykge1xuXG4gIHZhciBwYXJ0cyA9ICQkcGFydGlmeShwYXRoKTtcbiAgdmFyIGZpcnN0O1xuXG4gIGlmICh0eXBlb2YgbyAhPT0gJ29iamVjdCcpXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZ2V0KCk6IGV4cGVjdHMgYW4gb2JqZWN0IGdvdCAnICsgdHlwZW9mIG8pO1xuXG4gIGlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHJldHVybiBvWyQkdW5lc2NhcGVfZG90cyhwYXJ0c1swXSldO1xuICBpZiAocGFydHMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cbiAgZmlyc3QgPSBvW3BhcnRzLnNoaWZ0KCldO1xuXG4gIHJldHVybiAoKHR5cGVvZiBvID09PSAnb2JqZWN0JykgJiYgKG8gIT09IG51bGwpKSA/XG5cbiAgICBwYXJ0cy5yZWR1Y2UoZnVuY3Rpb24odGFyZ2V0LCBwcm9wKSB7XG4gICAgICBpZiAodGFyZ2V0ID09IG51bGwpIHJldHVybiB0YXJnZXQ7XG4gICAgICByZXR1cm4gdGFyZ2V0WyQkdW5lc2NhcGVfZG90cyhwcm9wKV07XG4gICAgfSwgZmlyc3QpIDogbnVsbDtcbn1cblxuZnVuY3Rpb24gJCRhZG9wdChjaGlsZCwgZSkge1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGQpKVxuICAgICAgcmV0dXJuIGNoaWxkLmZvckVhY2goaW5uZXJDaGlsZCA9PiAkJGFkb3B0KGlubmVyQ2hpbGQsIGUpKTtcblxuICAgIGlmIChjaGlsZClcbiAgICAgIGUuYXBwZW5kQ2hpbGQoXG4gICAgICAgICh0eXBlb2YgY2hpbGQgPT09ICdvYmplY3QnKSA/XG4gICAgICAgIGNoaWxkIDogZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY2hpbGQgPT0gbnVsbD8gJycgOiBjaGlsZCkpO1xuXG59XG5cbi8qKlxuICogJCR0ZXh0IGNyZWF0ZXMgYSBET01UZXh0Tm9kZVxuICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlXG4gKi9cbmZ1bmN0aW9uICQkdGV4dCh2YWx1ZSkge1xuXG4gIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh2YWx1ZSA9PSBudWxsID8gICcnIDogdmFsdWUpO1xuXG59XG5cbi8qKlxuICogJCRyZXNvbHZlIHByb3BlcnR5IGFjY2VzcyBleHByZXNzaW9uIHRvIGF2b2lkXG4gKiB0aG93aW5nIGVycm9ycyBpZiBpdCBkb2VzIG5vdCBleGlzdC5cbiAqIEBwYXJhbSB7b2JqZWN0fSBoZWFkXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0aFxuICovXG5mdW5jdGlvbiAkJHJlc29sdmUoaGVhZCwgcGF0aCkge1xuXG4gICAgaWYoKGhlYWQgPT0gbnVsbCkgfHwgaGVhZCA9PSAnJylcbiAgICAgICAgcmV0dXJuICcnO1xuXG4gIHZhciByZXQgPSAkJHByb3BlcnR5KHBhdGgsIGhlYWQpO1xuXG4gIHJldHVybiAocmV0ID09IG51bGwpID8gJycgOiByZXQ7XG5cbn1cblxuLyoqXG4gKiAkJG5vZGUgaXMgY2FsbGVkIHRvIGNyZWF0ZSBhIHJlZ3VsYXIgRE9NIG5vZGVcbiAqIEBwYXJhbSB7c3RyaW5nfSB0YWdcbiAqIEBwYXJhbSB7b2JqZWN0fSBhdHRyaWJ1dGVzXG4gKiBAcGFyYW0ge2FycmF5PHN0cmluZ3xudW1iZXJ8V2lkZ2V0Pn0gY2hpbGRyZW5cbiAqIEBwYXJhbSB7Vmlld30gdmlld1xuICovXG5mdW5jdGlvbiAkJG5vZGUodGFnLCBhdHRyaWJ1dGVzLCBjaGlsZHJlbiwgdmlldykge1xuXG4gIHZhciBlID0gKHRhZyA9PT0gJ2ZyYWdtZW50JykgPyBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCkgOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7XG5cbiAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVzLmh0bWwgPT09ICdvYmplY3QnKVxuICAgIE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMuaHRtbCkuZm9yRWFjaChrZXkgPT4ge1xuXG4gICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZXMuaHRtbFtrZXldID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGVba2V5XSA9IGF0dHJpYnV0ZXMuaHRtbFtrZXldO1xuICAgICAgfSBlbHNlIGlmKChhdHRyaWJ1dGVzLmh0bWxba2V5XSAhPSBudWxsKSAmJiAoYXR0cmlidXRlcy5odG1sW2tleV0gIT0gJycpKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignd2VsbCAnLCBrZXksIGF0dHJpYnV0ZXMuaHRtbFtrZXldKTtcbiAgICAgICAgZS5zZXRBdHRyaWJ1dGUoa2V5LCBhdHRyaWJ1dGVzLmh0bWxba2V5XSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgY2hpbGRyZW4uZm9yRWFjaChjID0+ICQkYWRvcHQoYywgZSkpO1xuXG4gIGlmIChhdHRyaWJ1dGVzLndtbClcbiAgICBpZiAoYXR0cmlidXRlcy53bWwuaWQpXG4gICAgICB2aWV3LnJlZ2lzdGVyKGF0dHJpYnV0ZXMud21sLmlkLCBlKTtcblxuICByZXR1cm4gZTtcblxufVxuXG4vKipcbiAqIEF0dHJpYnV0ZXMgcHJvdmlkZXMgYW4gQVBJIGZvciByZWFkaW5nIHRoZVxuICogYXR0cmlidXRlcyBzdXBwbGllZCB0byBhbiBFbGVtZW50LlxuICogQHBhcmFtIHtvYmplY3R9IGF0dHJzXG4gKi9cbmNsYXNzIEF0dHJpYnV0ZXMge1xuXG4gICAgY29uc3RydWN0b3IoJHtfdHMobywgJ3B1YmxpYyBfYXR0cnM6YW55JywgICdfYXR0cnMnKX0pIHtcblxuICAgICAgICB0aGlzLl9hdHRycyA9IF9hdHRycztcblxuICAgIH1cblxuICAgICR7X3RzKG8sICdoYXMocGF0aDpzdHJpbmcpOiBib29sZWFuJywgJ2hhcyhwYXRoKScpfXtcblxuICAgICAgcmV0dXJuIHRoaXMucmVhZChwYXRoKSAhPSBudWxsO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmVhZCBhIHZhbHVlIGZvcm0gdGhlIGludGVybmFsIGxpc3QuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGhcbiAgICAgKiBAcGFyYW0geyp9IGRlZmF1bHRWYWx1ZSAtIFRoaXMgdmFsdWUgaXMgcmV0dXJuZWQgaWYgdGhlIHZhbHVlIGlzIG5vdCBzZXQuXG4gICAgICovXG4gICAgJHtfdHMobywgJ3JlYWQ8QT4ocGF0aDpzdHJpbmcsIGRlZmF1bHRWYWx1ZT86QSk6IEEnLCAncmVhZChwYXRoLCBkZWZhdWx0VmFsdWUpJyl9IHtcblxuICAgICAgICB2YXIgcmV0ID0gJCRwcm9wZXJ0eShwYXRoLnNwbGl0KCc6Jykuam9pbignLicpLCB0aGlzLl9hdHRycyk7XG4gICAgICByZXR1cm4gKHJldCAhPSBudWxsKSA/IHJldCA6IChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgPyBkZWZhdWx0VmFsdWUgOiAnJztcblxuICAgIH1cblxufVxuXG5cbi8qKlxuICogJCR3aWRnZXQgY3JlYXRlcyBhIHdtbCB3aWRnZXQuXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBDb25zdHJ1dG9yXG4gKiBAcGFyYW0ge29iamVjdH0gYXR0cmlidXRlc1xuICogQHBhcmFtIHthcnJheTxzdHJpbmd8bnVtYmVyfFdpZGdldD59IGNoaWxkcmVuXG4gKiBAcGFyYW0ge1ZpZXd9IHZpZXdcbiAqIEByZXR1cm4ge1dpZGdldH1cbiAqL1xuZnVuY3Rpb24gJCR3aWRnZXQoQ29uc3RydWN0b3IsIGF0dHJpYnV0ZXMsIGNoaWxkcmVuLCB2aWV3KSB7XG5cbiAgdmFyIGNoaWxkcyA9IFtdO1xuICB2YXIgdztcblxuICBjaGlsZHJlbi5mb3JFYWNoKGNoaWxkID0+IEFycmF5LmlzQXJyYXkoY2hpbGQpID9cbiAgICBjaGlsZHMucHVzaC5hcHBseShjaGlsZHMsIGNoaWxkKSA6IGNoaWxkcy5wdXNoKGNoaWxkKSk7XG5cbiAgdyA9IG5ldyBDb25zdHJ1Y3RvcihuZXcgQXR0cmlidXRlcyhhdHRyaWJ1dGVzKSwgY2hpbGRzKTtcblxuICBpZiAoYXR0cmlidXRlcy53bWwpXG4gICAgaWYgKGF0dHJpYnV0ZXMud21sLmlkKVxuICAgICAgdmlldy5yZWdpc3RlcihhdHRyaWJ1dGVzLndtbC5pZCwgdyk7XG5cbiAgdmlldy53aWRnZXRzLnB1c2godyk7XG4gIHJldHVybiB3LnJlbmRlcigpO1xuXG59XG5cbi8qKlxuICogJCRpZiBpcyBjYWxsZWQgdG8gY3JlYXRlIGFuIGlmIGNvbmRpdGlvbmFsIGNvbnN0cnVjdFxuICogQHBhcmFtIHsqfSBwcmVkaWNhdGVcbiAqIEBwYXJhbSB7ZnVuY3Rpb259IHBvc2l0aXZlXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBuZWdhdGl2ZVxuICovXG5mdW5jdGlvbiAkJGlmKHByZWRpY2F0ZSwgcG9zaXRpdmUsIG5lZ2F0aXZlKSB7XG5cbiAgcmV0dXJuIChwcmVkaWNhdGUpID8gcG9zaXRpdmUoKSA6IG5lZ2F0aXZlKCk7XG5cbn1cblxuLyoqXG4gKiAkJGZvciBpcyBjYWxsZWQgdG8gY3JlYXRlIGEgZm9yIGxvb3AgY29uc3RydWN0XG4gKiBAcGFyYW0ge0l0ZXJhYmxlfSBjb2xsZWN0aW9uXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYlxuICovXG5mdW5jdGlvbiAkJGZvcihjb2xsZWN0aW9uLCBjYikge1xuXG4gIGlmIChBcnJheS5pc0FycmF5KGNvbGxlY3Rpb24pKSB7XG5cbiAgICByZXR1cm4gY29sbGVjdGlvbi5tYXAoY2IpO1xuXG4gICB9IGVsc2UgaWYgKHR5cGVvZiBjb2xsZWN0aW9uID09PSAnb2JqZWN0Jykge1xuXG4gICAgIHJldHVybiBPYmplY3Qua2V5cyhjb2xsZWN0aW9uKS5tYXAoKGtleSwgXywgYWxsKSA9PiBjYihjb2xsZWN0aW9uW2tleV0sIGtleSwgYWxsKSk7XG5cbiAgIH1cblxuICAgIHJldHVybiBbXTtcblxufVxuXG4vKipcbiAqICQkc3dpdGNoIHNpbXVsYXRlcyBhIHN3aXRjaCBzdGF0ZW1lbnRcbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcnxib29sZWFufSB2YWx1ZVxuICogQHBhcmFtIHtvYmplY3R9IGNhc2VzXG4gKi9cbmZ1bmN0aW9uICQkc3dpdGNoKHZhbHVlLCBjYXNlcykge1xuXG4gICAgdmFyIHJlc3VsdCA9IGNhc2VzW3ZhbHVlXTtcbiAgICB2YXIgZGVmYXVsID0gY2FzZXMuZGVmYXVsdDtcblxuICAgIGlmIChyZXN1bHQpIHJldHVybiByZXN1bHQ7XG5cbiAgICBpZiAoZGVmYXVsKSByZXR1cm4gZGVmYXVsO1xuXG59XG5cbiR7X3RzKG8sIF92aWV3KCkpfVxuJHtfdHMobywgX3dpZGdldCgpKX1cbiR7X3RzKG8sIF9lbGVtZW50KCkpfWA7XG5cbmNvbnN0IF9yb290RWxlbWVudCA9IChyb290LCBvKSA9PlxuICAgIHJvb3QgPyByb290LnRyYW5zcGlsZShvKSA6IChvLnR5cGVzY3JpcHQpID9cbiAgICAnPEhUTUxFbGVtZW50PjxOb2RlPmRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKScgOlxuICAgICdkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCknO1xuXG5leHBvcnQgY29uc3QgdmlldyA9IChuYW1lLCB0YWcsIG8pID0+XG5cbiAgICBgZXhwb3J0IGNsYXNzICR7bmFtZX0gJHtvLnR5cGVzY3JpcHQ/ICdpbXBsZW1lbnRzIFZpZXcnIDogJyd9e1xuXG4gICAgICAkeyhvLnR5cGVzY3JpcHQpPyBfdHlwZXNjcmlwdFByb3BlcnRpZXMoKSA6ICcnfVxuXG4gICAgICAgY29uc3RydWN0b3IoY29udGV4dCkge1xuXG4gICAgICAgICAgbGV0IHZpZXcgPSB0aGlzO1xuXG4gICAgICAgICAgdGhpcy5pZHMgPSB7fTtcbiAgICAgICAgICB0aGlzLndpZGdldHMgPSBbXTtcblxuICAgICAgICAgIHRoaXMudHJlZSA9IG51bGw7XG4gICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcbiAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIHJldHVybiAke19yb290RWxlbWVudCh0YWcsIG8pfVxuICAgICAgICAgIH1cblxuICAgICAgIH1cblxuICAgICAgIHN0YXRpYyByZW5kZXIoY29udGV4dCkge1xuXG4gICAgICAgICByZXR1cm4gKG5ldyAke25hbWV9KGNvbnRleHQpKS5yZW5kZXIoKTtcblxuICAgICAgIH1cblxuICAgICAgICR7by50eXBlc2NyaXB0PyAncmVnaXN0ZXIoaWQ6c3RyaW5nLCB3OldNTEVsZW1lbnQpOiAnK25hbWUgOiAncmVnaXN0ZXIoaWQsIHcpJ317XG5cblxuICAgICAgICAgaWYgKHRoaXMuaWRzLmhhc093blByb3BlcnR5KGlkKSlcbiAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEdXBsaWNhdGUgaWQgXFxcXCcnICtpZCsnXFxcXCcgZGV0ZWN0ZWQhJyk7XG5cbiAgICAgICAgIHRoaXMuaWRzW2lkXSA9IHc7XG4gICAgICAgICByZXR1cm4gdGhpcztcblxuICAgICAgIH1cblxuICAgICAgICR7by50eXBlc2NyaXB0PyAnZmluZEJ5SWQoaWQ6c3RyaW5nKSA6IFdNTEVsZW1lbnQgJyA6ICdmaW5kQnlJZChpZCknfXtcblxuICAgICAgICByZXR1cm4gKHRoaXMuaWRzW2lkXSkgPyB0aGlzLmlkc1tpZF0gOiBudWxsO1xuXG4gICAgICAgfVxuXG4gICAgICAgJHtvLnR5cGVzY3JpcHQ/ICdpbnZhbGlkYXRlKCk6IHZvaWQnIDogJ2ludmFsaWRhdGUoKSd9IHtcblxuICAgICAgICB2YXIgY2hpbGRzO1xuICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy50cmVlLnBhcmVudE5vZGU7XG4gICAgICAgIHZhciByZWFsRmlyc3RDaGlsZDtcbiAgICAgICAgdmFyIHJlYWxGaXJzdENoaWxkSW5kZXg7XG5cbiAgICAgICAgIGlmICh0aGlzLnRyZWUgPT0gbnVsbClcbiAgICAgICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCdDYW5ub3QgaW52YWxpZGF0ZSBhIHZpZXcgdGhhdCBoYXMgbm90IGJlZW4gcmVuZGVyZWQhJyk7XG5cbiAgICAgICAgIGlmICh0aGlzLnRyZWUucGFyZW50Tm9kZSA9PSBudWxsKVxuICAgICAgICAgICB0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoJ0F0dGVtcHQgdG8gaW52YWxpZGF0ZSBhIHZpZXcgdGhhdCBoYXMgbm90IGJlZW4gaW5zZXJ0ZWQgdG8gRE9NIScpO1xuXG4gICAgICAgICBjaGlsZHMgPSAke28udHlwZXNjcmlwdD8gJyg8RWxlbWVudD4gdGhpcy50cmVlLnBhcmVudE5vZGUpJyA6ICd0aGlzLnRyZWUucGFyZW50Tm9kZSd9LmNoaWxkcmVuO1xuXG4gICAgICAgICAvL2ZvciBzb21lIHJlYXNvbiB0aGUgcmVmZXJlbmNlIHN0b3JlZCBkb2VzIG5vdCBoYXZlIHRoZSBjb3JyZWN0IHBhcmVudCBub2RlLlxuICAgICAgICAgLy93ZSBkbyB0aGlzIHRvIGdldCBhICdsaXZlJyB2ZXJzaW9uIG9mIHRoZSBub2RlLlxuICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHMubGVuZ3RoOyBpKyspXG4gICAgICAgICAgIGlmIChjaGlsZHNbaV0gPT09IHRoaXMudHJlZSkge1xuICAgICAgICAgICAgIHJlYWxGaXJzdENoaWxkID0gY2hpbGRzW2ldO1xuICAgICAgICAgICAgIHJlYWxGaXJzdENoaWxkSW5kZXggPSBpO1xuICAgICAgICAgICB9XG5cbiAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQodGhpcy5yZW5kZXIoKSwgcmVhbEZpcnN0Q2hpbGQpO1xuXG4gICAgICAgfVxuXG4gICAgICAgcmVuZGVyKCkge1xuXG4gICAgICAgIHRoaXMuaWRzID0ge307XG4gICAgICAgIHRoaXMud2lkZ2V0cy5mb3JFYWNoKHcgPT4gdy5yZW1vdmVkKCkpO1xuICAgICAgICB0aGlzLndpZGdldHMgPSBbXTtcbiAgICAgICAgdGhpcy50cmVlID0gdGhpcy50ZW1wbGF0ZS5jYWxsKHRoaXMuY29udGV4dCk7XG4gICAgICAgIHRoaXMuaWRzWydyb290J10gPSAodGhpcy5pZHNbJ3Jvb3QnXSk/IHRoaXMuaWRzWydyb290J106dGhpcy50cmVlO1xuICAgICAgICB0aGlzLndpZGdldHMuZm9yRWFjaCh3ID0+IHcucmVuZGVyZWQoKSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudHJlZTtcblxuICAgICAgfVxuXG4gICAgIH1cblxuICAgIGA7XG4iXX0=